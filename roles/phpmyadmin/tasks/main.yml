- name: Install docker.io
  ansible.builtin.apt:
    name: docker.io
    state: present
    update_cache: yes
  tags: [phpmyadmin]

- name: Ensure Docker daemon is running
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes
  tags: [phpmyadmin]

- name: Pull phpMyAdmin image
  community.docker.docker_image:
    name: phpmyadmin
    source: pull
    force_source: no
  tags: [phpmyadmin]

- name: Run phpMyAdmin container
  community.docker.docker_container:
    name: "{{ phpmyadmin_container_name }}"
    image: phpmyadmin
    restart_policy: unless-stopped
    recreate: no  # Ne pas recréer si la configuration est la même
    force_kill: no  # Arrêt propre si nécessaire
    env:
      PMA_ARBITRARY: "1"
      PMA_HOST: "localhost"
      MYSQL_ROOT_PASSWORD: "{{ db_password }}"
      UPLOAD_LIMIT: "64M"
    ports:
      - "80:80"
    state: started
    comparisons:
      env: strict
      image: strict
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  tags: [phpmyadmin]