---
# Install and configure Apache web server
- name: Update APT and upgrade system (Web)
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600
  tags: [web]

- name: Install Apache, PHP, and required packages
  ansible.builtin.apt:
    name:
      - apache2
      - php
      - php-mysql
      - mariadb-client
      - lynx
      - apache2-utils
      - apache2-bin
      - python3-pymysql
      - python3-pip
      - libapache2-mod-php
    state: present
    update_cache: yes
    cache_valid_time: 3600
  tags: [web]

- name: Install apache2 and headers module
  ansible.builtin.apt:
    name: apache2
    state: present
  tags: [web]

- name: Remove old security headers from security.conf
  ansible.builtin.lineinfile:
    path: /etc/apache2/conf-enabled/security.conf
    regexp: '^(\s)*Header.*$'
    state: absent
  notify: restart apache
  tags: [web]

- name: Enable headers module
  community.general.apache2_module:
    name: headers
    state: present
    ignore_configcheck: true
  notify: restart apache
  tags: [web]

- name: Enable PHP module
  community.general.apache2_module:
    name: php
    state: present
    ignore_configcheck: true
  notify: restart apache
  tags: [web]

- name: Copy security headers configuration
  ansible.builtin.copy:
    src: security-headers.conf
    dest: /etc/apache2/conf-available/security-headers.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart apache
  tags: [web]

- name: Enable security headers configuration
  ansible.builtin.file:
    src: /etc/apache2/conf-available/security-headers.conf
    dest: /etc/apache2/conf-enabled/security-headers.conf
    state: link
  notify: restart apache
  tags: [web]

# Rest of the web server configuration
- name: Ensure /var/www/html exists with correct permissions
  ansible.builtin.file:
    path: /var/www/html
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
  tags: [web]

- name: Deploy PHP info page
  ansible.builtin.template:
    src: info.php.j2
    dest: /var/www/html/info.php
    owner: www-data
    group: www-data
    mode: '0644'
  notify: restart apache
  tags: [web]

- name: Deploy table dump script
  ansible.builtin.template:
    src: dump.table.php.j2
    dest: /var/www/html/dump.table.php
    owner: www-data
    group: www-data
    mode: '0644'
  notify: restart apache
  tags: [web]

- name: Deploy index page
  ansible.builtin.template:
    src: index.html.j2
    dest: /var/www/html/index.html
    owner: www-data
    group: www-data
    mode: '0644'
  notify: restart apache
  tags: [web]

- name: Validate Apache configuration
  ansible.builtin.command: apache2ctl -t
  changed_when: false
  register: apache_config_test
  tags: [web]

- name: Ensure Apache is running and enabled
  ansible.builtin.service:
    name: apache2
    state: started
    enabled: yes
  tags: [web]

- name: Wait for database to be reachable
  ansible.builtin.wait_for:
    host: "{{ hostvars[groups['tag_Role_DB'][0]].private_ip_address }}"
    port: 3306
    timeout: 300
    connect_timeout: 5
    delay: 10
    sleep: 5
  register: wait_db
  until: wait_db is success
  retries: 6
  delay: 10
  tags: [web]

- name: Test database connectivity with mysql client
  ansible.builtin.shell: |
    mysql -h {{ hostvars[groups['tag_Role_DB'][0]].private_ip_address }} -u {{ db_user }} -p'{{ db_password }}' -e 'SELECT 1;' {{ db_name }}
  register: mysql_test
  changed_when: false
  ignore_errors: yes
  no_log: true
  tags: [web]

- name: Display MySQL test result
  ansible.builtin.debug:
    var: mysql_test.stdout_lines
  when: mysql_test is defined
  no_log: false
  tags: [web]

- name: Install netcat for connectivity testing
  ansible.builtin.apt:
    name: netcat-openbsd
    state: present
  tags: [web]

- name: Test database port with netcat
  ansible.builtin.shell: |
    nc -zv {{ hostvars[groups['tag_Role_DB'][0]].private_ip_address }} 3306
  register: nc_result
  changed_when: false
  ignore_errors: yes
  tags: [web]

- name: Display netcat test result
  ansible.builtin.debug:
    var: nc_result.stderr
  tags: [web]

- name: Verify PHP MySQL connectivity
  ansible.builtin.copy:
    content: |
      <?php
      $conn = new mysqli("{{ hostvars[groups['tag_Role_DB'][0]].private_ip_address }}", "{{ db_user }}", "{{ db_password }}", "{{ db_name }}");
      if ($conn->connect_error) {
        echo "Connection failed: " . $conn->connect_error;
        exit(1);
      }
      echo "Connected successfully";
      $conn->close();
      ?>
    dest: /var/www/html/db_test.php
    owner: www-data
    group: www-data
    mode: '0644'
  tags: [web]
