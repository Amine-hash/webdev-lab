---
# Install and configure Apache web server
- name: Update APT and upgrade system (Web)
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600
  tags: [web]

- name: Install Apache, PHP, and required packages
  ansible.builtin.apt:
    name:
      - apache2
      - php
      - php-mysql
      - mariadb-client
      - lynx
      - apache2-utils
      - apache2-bin
      - python3-pymysql
      - libapache2-mod-php
    state: present
    update_cache: yes
    cache_valid_time: 3600
    dpkg_options: "force-confold,force-confdef"
  tags: [web]

# Ensure headers module is available and enabled
- name: Install headers module
  ansible.builtin.apt:
    name: apache2
    state: present
  tags: [web]

- name: Remove old security headers from security.conf
  ansible.builtin.lineinfile:
    path: /etc/apache2/conf-enabled/security.conf
    regexp: '^(\s)*Header.*$'
    state: absent
  notify: restart apache
  tags: [web]

- name: Enable headers module
  community.general.apache2_module:
    name: headers
    state: present
  notify: restart apache
  tags: [web]

- name: Copy security headers configuration
  ansible.builtin.copy:
    src: security-headers.conf
    dest: /etc/apache2/conf-available/security-headers.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart apache
  tags: [web]

- name: Enable security headers configuration
  ansible.builtin.file:
    src: /etc/apache2/conf-available/security-headers.conf
    dest: /etc/apache2/conf-enabled/security-headers.conf
    state: link
  notify: restart apache
  tags: [web]

# Rest of the web server configuration
- name: Ensure /var/www/html exists with correct permissions
  ansible.builtin.file:
    path: /var/www/html
    state: directory
    owner: "{{ web_user }}"
    group: "{{ web_group }}"
    mode: '0755'
  tags: [web]

- name: Deploy PHP info page
  ansible.builtin.template:
    src: info.php.j2
    dest: /var/www/html/info.php
    owner: "{{ web_user }}"
    group: "{{ web_group }}"
    mode: '0644'
  notify: restart apache
  tags: [web]

- name: Deploy table dump script
  ansible.builtin.template:
    src: dump.table.php.j2
    dest: /var/www/html/dump.table.php
    owner: "{{ web_user }}"
    group: "{{ web_group }}"
    mode: '0644'
  notify: restart apache
  tags: [web]

- name: Deploy index page
  ansible.builtin.template:
    src: index.html.j2
    dest: /var/www/html/index.html
    owner: "{{ web_user }}"
    group: "{{ web_group }}"
    mode: '0644'
  notify: restart apache
  tags: [web]

- name: Validate Apache configuration
  ansible.builtin.command: apache2ctl -t
  changed_when: false
  register: apache_config_test
  tags: [web]

- name: Ensure Apache is running and enabled
  ansible.builtin.service:
    name: apache2
    state: started
    enabled: yes
  tags: [web]

- name: Check database connectivity
  community.mysql.mysql_query:
    login_host: "{{ db_host }}"
    login_user: "{{ db_user }}"
    login_password: "{{ db_password }}"
    login_db: "{{ db_name }}"
    login_port: "{{ db_port }}"
    query: "SELECT 1"
  register: db_check
  ignore_errors: yes
  tags: [web]

- name: Display database connectivity result
  ansible.builtin.debug:
    var: db_check
  when: db_check is defined
  tags: [web]

- name: Ensure web server can connect to database
  ansible.builtin.wait_for:
    host: "{{ db_host }}"
    port: "{{ db_port }}"
    timeout: 30
    state: started
  register: db_port_check
  tags: [web]

- name: Test MySQL connectivity from command line
  ansible.builtin.command:
    cmd: "mysql -h {{ db_host }} -u {{ db_user }} -p'{{ db_password }}' -e 'SELECT 1;'"
  register: mysql_test
  changed_when: false
  ignore_errors: yes
  no_log: true
  tags: [web]

- name: Display MySQL test result
  ansible.builtin.debug:
    msg: "{{ mysql_test }}"
  when: mysql_test is defined
  tags: [web]
