- name: Update APT and upgrade system (Web)
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
  tags: [web]

- name: Install Apache, PHP, DB client and lynx
  ansible.builtin.apt:
    name:
      - apache2
      - php
      - php-mysql
      - mariadb-client
      - lynx
      - apache2-utils
      - apache2-bin
      - libapache2-mod-php
    state: present
  tags: [web]

- name: Enable Apache headers module
  apache2_module:
    name: headers
    state: present
  notify: restart apache
  tags: [web]

- name: Enable Apache php module
  apache2_module:
    name: php
    state: present
  notify: restart apache
  tags: [web]

- name: Ensure Apache is started and enabled
  ansible.builtin.service:
    name: apache2
    state: started
    enabled: yes
  tags: [web]

- name: Create development group
  ansible.builtin.group:
    name: www-data
    state: present
  tags: [web]

- name: Ensure /var/www/html exists with correct permissions
  ansible.builtin.file:
    path: /var/www/html
    state: directory
    owner: www-data
    group: www-data
    mode: "0775"
  tags: [web]

- name: Deploy index.html
  ansible.builtin.template:
    src: index.html.j2
    dest: /var/www/html/index.html
    owner: www-data
    group: www-data
    mode: "0644"
    force: yes
  register: index_deployment
  tags: [web]

- name: Deploy info.php
  ansible.builtin.template:
    src: info.php.j2
    dest: /var/www/html/info.php
    owner: www-data
    group: www-data
    mode: "0644"
    force: yes
  register: info_deployment
  tags: [web]

- name: Compute DB host private IP (first DB server)
  ansible.builtin.set_fact:
    db_host: "{{ hostvars[groups['tag_Role_DB'][0]].ansible_default_ipv4.address }}"
  when: groups['tag_Role_DB'] is defined and (groups['tag_Role_DB'] | length) > 0
  tags: [web]

- name: Deploy dump.table.php (PHP app connecting to DB)
  ansible.builtin.template:
    src: dump.table.php.j2
    dest: /var/www/html/dump.table.php
    owner: www-data
    group: www-data
    mode: "0644"
    force: yes
  register: dump_deployment
  notify: restart apache
  tags: [web]

# Les autorisations sont maintenant gérées par les tâches de déploiement ci-dessus
- name: Ensure Apache user can write cache
  ansible.builtin.file:
    path: /var/cache/apache2
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
    recurse: yes
  tags: [web]

- name: Validate Apache configuration
  ansible.builtin.command: apache2ctl configtest
  changed_when: false
  notify: reload apache
  tags: [web]

- name: Add security headers to Apache configuration
  ansible.builtin.blockinfile:
    path: /etc/apache2/conf-available/security.conf
    block: |
      Header set X-Content-Type-Options "nosniff"
      Header set X-Frame-Options "SAMEORIGIN"
      Header set X-XSS-Protection "1; mode=block"
      Header set Content-Security-Policy "default-src 'self'"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - SECURITY HEADERS"
  notify: reload apache
  tags: [web]
