- name: Check Apache installation status
  ansible.builtin.stat:
    path: /usr/sbin/apache2
  register: apache_installed
  tags: [web]

- name: Update APT and upgrade system (Web)
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600  # Add cache validity to avoid unnecessary updates
  tags: [web]

- name: Install Apache, PHP, DB client and lynx
  ansible.builtin.apt:
    name:
      - apache2
      - php
      - php-mysql
      - mariadb-client
      - lynx
      - apache2-utils
      - apache2-bin
      - python3-pymysql
      - libapache2-mod-php
      - apache2-mod-headers
    state: present
    update_cache: yes
    cache_valid_time: 3600
    dpkg_options: 'force-confold,force-confdef'
    install_recommends: yes
  register: packages_installed
  tags: [web]

- name: Enable mod_headers for Apache
  apache2_module:
    name: headers
    state: present
  notify: restart apache
  tags: [web]

- name: Get list of enabled Apache modules
  ansible.builtin.command: apache2ctl -M
  register: enabled_modules
  changed_when: false
  tags: [web]

- name: Enable required Apache modules
  apache2_module:
    name: "{{ item }}"
    state: present
  with_items:
    - php
    - rewrite
  notify: restart apache
  tags: [web]

- name: Ensure /var/www/html exists with correct permissions
  ansible.builtin.file:
    path: /var/www/html
    state: directory
    owner: "{{ web_user }}"
    group: "{{ web_group }}"
    mode: '0755'
  tags: [web]

- name: Deploy PHP info page
  ansible.builtin.template:
    src: info.php.j2
    dest: /var/www/html/info.php
    owner: "{{ web_user }}"
    group: "{{ web_group }}"
    mode: '0644'
    force: no  # Ne pas écraser si identique
  tags: [web]

- name: Deploy table dump script
  ansible.builtin.template:
    src: dump.table.php.j2
    dest: /var/www/html/dump.table.php
    owner: "{{ web_user }}"
    group: "{{ web_group }}"
    mode: '0644'
    force: no  # Ne pas écraser si identique
  tags: [web]

- name: Deploy index page
  ansible.builtin.template:
    src: index.html.j2
    dest: /var/www/html/index.html
    owner: "{{ web_user }}"
    group: "{{ web_group }}"
    mode: '0644'
    force: no  # Ne pas écraser si identique
  tags: [web]

- name: Ensure Apache is started and enabled
  ansible.builtin.service:
    name: apache2
    state: started
    enabled: yes
  tags: [web]

- name: Validate Apache configuration
  ansible.builtin.command: apache2ctl -t
  changed_when: false
  register: apache_config_test
  tags: [web]

- name: Add security headers to Apache configuration
  ansible.builtin.blockinfile:
    path: /etc/apache2/conf-available/security.conf
    block: |
      Header set X-Content-Type-Options "nosniff"
      Header set X-Frame-Options "SAMEORIGIN"
      Header set X-XSS-Protection "1; mode=block"
      Header set Content-Security-Policy "default-src 'self'"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - SECURITY HEADERS"
  notify: reload apache
  tags: [web]

- name: Enable security configuration
  ansible.builtin.command: a2enconf security
  register: enable_security
  changed_when: enable_security.rc == 0
  notify: reload apache
  tags: [web]

- name: Check database connectivity
  community.mysql.mysql_query:
    login_host: "{{ db_host }}"
    login_user: "{{ db_user }}"
    login_password: "{{ db_password }}"
    login_db: "{{ db_name }}"
    login_port: "{{ db_port }}"
    query: "SELECT 1"
  register: db_check
  ignore_errors: yes
  tags: [web]

- name: Display database connectivity status
  debug:
    msg: "Database connection {{ 'succeeded' if db_check.failed is not defined else 'failed: ' + db_check.msg }}"
  tags: [web]
