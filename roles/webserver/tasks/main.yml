- name: Update APT and upgrade system (Web)
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600  # Add cache validity to avoid unnecessary updates
  tags: [web]

- name: Install Apache, PHP, DB client and lynx
  ansible.builtin.apt:
    name:
      - apache2
      - php
      - php-mysql
      - mariadb-client
      - lynx
      - apache2-utils
      - apache2-bin
      - libapache2-mod-php
    state: present
  tags: [web]

- name: Enable required Apache modules
  apache2_module:
    name: "{{ item }}"
    state: present
  with_items:
    - headers
    - php
  notify: restart apache
  tags: [web]

- name: Ensure Apache is started and enabled
  ansible.builtin.service:
    name: apache2
    state: started
    enabled: yes
  tags: [web]

- name: Ensure /var/www/html exists with correct permissions
  ansible.builtin.file:
    path: /var/www/html
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
  tags: [web]

- name: Copy web files
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/var/www/html/{{ item | basename | regex_replace('\\.j2$', '') }}"
    owner: www-data
    group: www-data
    mode: '0644'
    force: no  # Ne pas écraser si le fichier existe déjà
  with_items:
    - index.html.j2
    - info.php.j2
    - dump.table.php.j2
  notify: restart apache
  tags: [web]

- name: Compute DB host private IP (first DB server)
  ansible.builtin.set_fact:
    db_host: "{{ hostvars[groups['tag_Role_DB'][0]].ansible_default_ipv4.address }}"
  when: groups['tag_Role_DB'] is defined and (groups['tag_Role_DB'] | length) > 0
  tags: [web]

# Les autorisations sont maintenant gérées par les tâches de déploiement ci-dessus
- name: Ensure Apache user can write cache
  ansible.builtin.file:
    path: /var/cache/apache2
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
    recurse: yes
  tags: [web]

- name: Validate Apache configuration
  ansible.builtin.command: apache2ctl configtest
  changed_when: false
  notify: reload apache
  tags: [web]

- name: Add security headers to Apache configuration
  ansible.builtin.blockinfile:
    path: /etc/apache2/conf-available/security.conf
    block: |
      Header set X-Content-Type-Options "nosniff"
      Header set X-Frame-Options "SAMEORIGIN"
      Header set X-XSS-Protection "1; mode=block"
      Header set Content-Security-Policy "default-src 'self'"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - SECURITY HEADERS"
  notify: reload apache
  tags: [web]

- name: Check database connectivity
  community.mysql.mysql_query:
    login_host: "{{ db_host }}"
    login_user: "{{ db_user }}"
    login_password: "{{ db_password }}"
    login_db: "{{ db_name }}"
    query: "SELECT 1"
  register: db_check
  ignore_errors: yes
  tags: [web]

- name: Display database connectivity status
  debug:
    msg: "Database connection {{ 'succeeded' if db_check.failed is not defined else 'failed: ' + db_check.msg }}"
  tags: [web]
