- name: Check if MariaDB is already configured
  ansible.builtin.stat:
    path: /var/lib/mysql/{{ db_name }}
  register: db_configured
  tags: [db]

- name: Update APT and upgrade system (DB)
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600  # Add cache validity
  tags: [db]

- name: Install MariaDB and required packages
  ansible.builtin.apt:
    name:
      - mariadb-server
      - python3-pymysql
      - net-tools
      - iproute2
    state: present
    update_cache: yes
    cache_valid_time: 3600
  tags: [db]

- name: Ensure mysql directories exist with correct permissions
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: mysql
    group: mysql
    mode: '0755'
  with_items:
    - /var/run/mysqld
    - /var/lib/mysql
    - /var/log/mysql
  tags: [db]

- name: Configure MariaDB to listen on all interfaces
  ansible.builtin.template:
    src: mariadb.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/50-server.cnf
    owner: root
    group: root
    mode: '0644'
  notify: restart mariadb
  tags: [db]

- name: Stop MariaDB service
  ansible.builtin.service:
    name: mariadb
    state: stopped
  tags: [db]

- name: Clear existing locks and temporary files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /var/lib/mysql/aria_log_control
    - /var/run/mysqld/mysqld.pid
    - /var/lib/mysql/mysql.sock
    - /var/lib/mysql/ibdata1.lck
  ignore_errors: yes
  tags: [db]

- name: Initialize MariaDB data directory if needed
  ansible.builtin.command:
    cmd: mysql_install_db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
    creates: /var/lib/mysql/mysql
  become: yes
  tags: [db]

- name: Start MariaDB service
  ansible.builtin.service:
    name: mariadb
    state: started
    enabled: yes
  tags: [db]

- name: Wait for MariaDB to be ready
  ansible.builtin.wait_for:
    path: /var/run/mysqld/mysqld.sock
    state: present
    timeout: 60
  tags: [db]

- name: Create database
  community.mysql.mysql_db:
    name: "{{ db_name }}"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
  register: db_created
  tags: [db]

- name: Create .my.cnf file for root
  ansible.builtin.template:
    src: my.cnf.j2
    dest: /root/.my.cnf
    mode: '0600'
    owner: root
    group: root
  tags: [db]

- name: Create database user
  community.mysql.mysql_user:
    name: "{{ db_user }}"
    password: "{{ db_password }}"
    host: "%"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
  tags: [db]

- name: Grant privileges to database user
  community.mysql.mysql_user:
    name: "{{ db_user }}"
    password: "{{ db_password }}"
    priv: "*.*:ALL,GRANT"
    host: "%"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
  tags: [db]

- name: Ensure MariaDB is listening on network
  ansible.builtin.wait_for:
    host: 0.0.0.0
    port: 3306
    timeout: 30
    state: started
  tags: [db]

- name: Verify MariaDB network accessibility
  ansible.builtin.shell: "ss -tuln | grep ':3306' || true"
  register: mysql_listening
  changed_when: false
  tags: [db]

- name: Allow MariaDB port in UFW
  ansible.builtin.ufw:
    rule: allow
    port: 3306
    proto: tcp
  tags: [db]

- name: Get UFW status
  ansible.builtin.command: ufw status
  register: ufw_status
  changed_when: false
  tags: [db]

- name: Display UFW status
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
  tags: [db]
