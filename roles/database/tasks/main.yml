---
- name: Check if MariaDB is already configured
  ansible.builtin.stat:
    path: /var/lib/mysql/{{ db_name }}
  register: db_configured
  tags: [db]

- name: Update APT and upgrade system (DB)
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600
  tags: [db]

- name: Install MariaDB and required packages
  ansible.builtin.apt:
    name:
      - mariadb-server
      - python3-pymysql
      - net-tools
      - iproute2
    state: present
    update_cache: yes
    cache_valid_time: 3600
  tags: [db]

- name: Ensure mysql directories exist with correct permissions
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: mysql
    group: mysql
    mode: '0755'
  with_items:
    - /var/run/mysqld
    - /var/lib/mysql
    - /var/log/mysql
  tags: [db]

- name: Configure MariaDB to listen on all interfaces
  ansible.builtin.template:
    src: mariadb.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/50-server.cnf
    owner: root
    group: root
    mode: '0644'
  notify: restart mariadb
  tags: [db]

- name: Stop MariaDB service
  ansible.builtin.service:
    name: mariadb
    state: stopped
  tags: [db]

- name: Clear existing locks and temporary files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /var/lib/mysql/aria_log_control
    - /var/run/mysqld/mysqld.pid
    - /var/lib/mysql/mysql.sock
    - /var/lib/mysql/ibdata1.lck
  ignore_errors: yes
  tags: [db]

- name: Initialize MariaDB data directory if needed
  ansible.builtin.command:
    cmd: mysql_install_db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
    creates: /var/lib/mysql/mysql
  become: yes
  tags: [db]

- name: Start MariaDB service
  ansible.builtin.service:
    name: mariadb
    state: started
    enabled: true
  tags: [db]

- name: Wait for MariaDB service to be ready
  ansible.builtin.wait_for:
    path: /var/run/mysqld/mysqld.sock
    timeout: 30
  tags: [db]

- name: Create database user
  community.mysql.mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    query: "CREATE USER IF NOT EXISTS '{{ db_user }}'@'%' IDENTIFIED BY '{{ db_password }}';"
  tags: [db]

- name: Grant privileges to database user
  community.mysql.mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    query: "GRANT ALL ON *.* TO '{{ db_user }}'@'%' WITH GRANT OPTION;"
  tags: [db]

- name: Flush privileges
  community.mysql.mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    query: FLUSH PRIVILEGES;
  tags: [db]

- name: Create database
  community.mysql.mysql_db:
    name: "{{ db_name }}"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
  tags: [db]

- name: Create Users table
  community.mysql.mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_db: "{{ db_name }}"
    query: |
      CREATE TABLE IF NOT EXISTS Users (
        ID INT PRIMARY KEY AUTO_INCREMENT,
        FirstName VARCHAR(50),
        LastName VARCHAR(50)
      );
  tags: [db]

- name: Clean Users table before inserting initial data
  community.mysql.mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_db: "{{ db_name }}"
    query: "DELETE FROM Users;"
  tags: [db]

- name: Insert initial data
  community.mysql.mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_db: "{{ db_name }}"
    query: |
      INSERT INTO Users (FirstName, LastName) VALUES 
        ('John', 'Doe'),
        ('Jane', 'Smith'),
        ('Bob', 'Johnson');
  tags: [db]

- name: Configure remote access bind-address using sed
  ansible.builtin.lineinfile:
    path: /etc/mysql/mariadb.conf.d/50-server.cnf
    regexp: '^bind-address\s*='
    line: 'bind-address = 0.0.0.0'
    backup: yes
  notify: restart mariadb
  tags: [db]

- name: Ensure MariaDB is running and enabled
  ansible.builtin.service:
    name: mariadb
    state: restarted
    enabled: yes
  tags: [db]

- name: Wait for MariaDB to be reachable
  ansible.builtin.wait_for:
    port: 3306
    timeout: 30
  tags: [db]

- name: Verify MariaDB network accessibility using ss
  ansible.builtin.shell:
    cmd: ss -tuln | grep :3306
  register: mysql_listening
  changed_when: false
  ignore_errors: yes
  tags: [db]

- name: Allow MariaDB port in UFW
  ansible.builtin.ufw:
    rule: allow
    port: 3306
    proto: tcp
  tags: [db]

- name: Get UFW status
  ansible.builtin.command: ufw status
  register: ufw_status
  changed_when: false
  tags: [db]

- name: Display UFW status
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
  tags: [db]
