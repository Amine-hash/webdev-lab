- name: Check if MariaDB is already configured
  ansible.builtin.stat:
    path: /var/lib/mysql/{{ db_name }}
  register: db_configured
  tags: [db]

- name: Update APT and upgrade system (DB)
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600  # Add cache validity
  tags: [db]

- name: Install MariaDB and PyMySQL
  ansible.builtin.apt:
    name:
      - mariadb-server
      - python3-pymysql
    state: present
    update_cache: yes
    cache_valid_time: 3600
  tags: [db]

- name: Ensure mysql directories exist with correct permissions
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: mysql
    group: mysql
    mode: '0755'
  with_items:
    - /var/run/mysqld
    - /var/lib/mysql
  tags: [db]

- name: Initialize MariaDB data directory if needed
  ansible.builtin.command:
    cmd: mariadb-install-db --user=mysql
    creates: /var/lib/mysql/mysql
  become: yes
  tags: [db]

- name: Configure MariaDB to listen on all interfaces
  ansible.builtin.lineinfile:
    path: /etc/mysql/mariadb.conf.d/50-server.cnf
    regexp: '^bind-address\s*='
    line: 'bind-address            = 0.0.0.0'
    state: present
    backup: no
  notify: restart mariadb
  tags: [db]

- name: Ensure MariaDB is started and enabled
  ansible.builtin.service:
    name: mariadb
    state: started
    enabled: yes
  tags: [db]

- name: Wait for MariaDB to be ready
  ansible.builtin.wait_for:
    path: /var/run/mysqld/mysqld.sock
    state: present
    timeout: 30
  tags: [db]

- name: Create database
  community.mysql.mysql_db:
    name: "{{ db_name }}"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
  register: db_created
  tags: [db]

- name: Create database user with privileges
  community.mysql.mysql_user:
    name: "{{ db_user }}"
    password: "{{ db_password }}"
    priv: "{{ db_name }}.*:ALL"
    host: '%'
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
  register: user_created
  tags: [db]

- name: Create Users table
  community.mysql.mysql_query:
    login_db: "{{ db_name }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
    query: |
      CREATE TABLE IF NOT EXISTS Users (
        ID INT PRIMARY KEY AUTO_INCREMENT,
        FirstName VARCHAR(50),
        LastName VARCHAR(50)
      );
  tags: [db]

- name: Check if table is empty
  community.mysql.mysql_query:
    login_db: "{{ db_name }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
    query: "SELECT COUNT(*) as count FROM Users;"
  register: users_count
  tags: [db]

- name: Insert initial data if table is empty
  community.mysql.mysql_query:
    login_db: "{{ db_name }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
    query: |
      INSERT INTO Users (FirstName, LastName) VALUES 
        ('John', 'Doe'),
        ('Jane', 'Smith'),
        ('Bob', 'Johnson');
  when: "users_count.query_result[0][0].count == '0'"
  tags: [db]

- name: Create .my.cnf file for root
  ansible.builtin.template:
    src: my.cnf.j2
    dest: /root/.my.cnf
    mode: '0600'
    owner: root
    group: root
    force: no  # Ne pas écraser si identique
  tags: [db]

- name: Check MariaDB service status
  ansible.builtin.service:
    name: mariadb
    state: started
  register: mariadb_status
  tags: [db]

- name: Check database connectivity
  community.mysql.mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
    query: SELECT VERSION()
  register: db_version
  changed_when: false
  tags: [db]

- name: Display MariaDB version
  debug:
    var: db_version.query_result
  tags: [db]

- name: Stop MariaDB service if running
  ansible.builtin.service:
    name: mariadb
    state: stopped
  tags: [db]

- name: Clear existing locks and temporary files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /var/lib/mysql/aria_log_control
    - /var/run/mysqld/mysqld.pid
    - /var/lib/mysql/mysql.sock
    - /var/lib/mysql/ibdata1.lck
  ignore_errors: yes
  tags: [db]

- name: Ensure MySQL directories have correct permissions
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: mysql
    group: mysql
    mode: '0750'
    recurse: yes
  with_items:
    - /var/lib/mysql
    - /var/run/mysqld
    - /var/log/mysql
  tags: [db]

- name: Configure MariaDB
  ansible.builtin.template:
    src: mariadb.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/50-server.cnf
    owner: root
    group: root
    mode: '0644'
  notify: restart mariadb
  tags: [db]

- name: Start MariaDB service
  ansible.builtin.service:
    name: mariadb
    state: started
    enabled: yes
  tags: [db]

- name: Wait for MariaDB to be ready
  ansible.builtin.wait_for:
    path: /var/run/mysqld/mysqld.sock
    state: present
    timeout: 60
  tags: [db]

- name: Create database
  community.mysql.mysql_db:
    name: "{{ db_name }}"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
  register: db_created
  tags: [db]

- name: Create database user with privileges
  community.mysql.mysql_user:
    name: "{{ db_user }}"
    password: "{{ db_password }}"
    priv: "{{ db_name }}.*:ALL"
    host: '%'
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
  register: user_created
  tags: [db]

- name: Create Users table
  community.mysql.mysql_query:
    login_db: "{{ db_name }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
    query: |
      CREATE TABLE IF NOT EXISTS Users (
        ID INT PRIMARY KEY AUTO_INCREMENT,
        FirstName VARCHAR(50),
        LastName VARCHAR(50)
      );
  tags: [db]

- name: Check if table is empty
  community.mysql.mysql_query:
    login_db: "{{ db_name }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
    query: "SELECT COUNT(*) as count FROM Users;"
  register: users_count
  tags: [db]

- name: Insert initial data if table is empty
  community.mysql.mysql_query:
    login_db: "{{ db_name }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
    query: |
      INSERT INTO Users (FirstName, LastName) VALUES 
        ('John', 'Doe'),
        ('Jane', 'Smith'),
        ('Bob', 'Johnson');
  when: "users_count.query_result[0][0].count == '0'"
  tags: [db]

- name: Create .my.cnf file for root
  ansible.builtin.template:
    src: my.cnf.j2
    dest: /root/.my.cnf
    mode: '0600'
    owner: root
    group: root
    force: no  # Ne pas écraser si identique
  tags: [db]

- name: Check MariaDB service status
  ansible.builtin.service:
    name: mariadb
    state: started
  register: mariadb_status
  tags: [db]

- name: Check database connectivity
  community.mysql.mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_user: root
    query: SELECT VERSION()
  register: db_version
  changed_when: false
  tags: [db]

- name: Display MariaDB version
  debug:
    var: db_version.query_result
  tags: [db]
