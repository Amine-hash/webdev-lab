- name: Create Bastion security group
  amazon.aws.ec2_security_group:
    name: "{{ bastion_sg_name }}"
    description: "Bastion SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    vpc_id: "{{ vpc_id | default(omit) }}"
    state: "{{ infra_state }}"
    purge_rules: no  # Ne pas purger les règles existantes pour éviter une recréation
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        cidr_ip: "{{ ssh_cidr }}"
        rule_desc: "Allow SSH from Internet"
    rules_egress:
      - proto: -1
        from_port: -1
        to_port: -1
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow all outbound traffic"
  register: bastion_sg
  tags: [infra]
  when: infra_state == "present"

- name: Set bastion_sg_id fact
  ansible.builtin.set_fact:
    bastion_sg_id: "{{ bastion_sg.group_id }}"
  when: infra_state == "present"

- name: Create Web security group
  amazon.aws.ec2_security_group:
    name: "{{ web_sg_name }}"
    description: "Web SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    vpc_id: "{{ vpc_id | default(omit) }}"
    state: "{{ infra_state }}"
    purge_rules: no  # Ne pas purger les règles existantes
    rules:
      - proto: tcp
        from_port: 80
        to_port: 80
        cidr_ip: "{{ web_http_cidr }}"
        rule_desc: "Allow HTTP from Internet"
      - proto: tcp
        from_port: 22
        to_port: 22
        group_id: "{{ bastion_sg_id }}"
        rule_desc: "Allow SSH only from Bastion"
    rules_egress:
      - proto: tcp
        from_port: 80
        to_port: 80
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow HTTP outbound"
      - proto: tcp
        from_port: 443
        to_port: 443
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow HTTPS outbound"
  register: web_sg
  when: infra_state == "present"

- name: Create DB security group
  amazon.aws.ec2_security_group:
    name: "{{ db_sg_name }}"
    description: "DB SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    vpc_id: "{{ vpc_id | default(omit) }}"
    state: "{{ infra_state }}"
    purge_rules: no  # Ne pas purger les règles existantes
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        group_id: "{{ bastion_sg_id }}"
        rule_desc: "Allow SSH from Bastion"
      - proto: tcp
        from_port: "{{ db_port }}"
        to_port: "{{ db_port }}"
        group_id: "{{ web_sg.group_id }}"
        rule_desc: "Allow DB access from Web servers"
    rules_egress:
      - proto: tcp
        from_port: 80
        to_port: 80
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow HTTP outbound"
      - proto: tcp
        from_port: 443
        to_port: 443
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow HTTPS outbound"
  register: db_sg
  when: infra_state == "present"

# Instance creation
- name: Launch instances
  block:
    - name: Get instances info
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Project": "{{ project_tag }}"
          "instance-state-name": "running"
      register: existing_instances

    - name: Create Bastion instance
      amazon.aws.ec2_instance:
        name: "{{ project_tag }}-bastion"
        security_group: "{{ bastion_sg_name }}"
        instance_type: "{{ instance_type }}"
        image_id: "{{ debian_ami_id }}"
        key_name: "{{ webdev_key_name }}"
        region: "{{ aws_region }}"
        state: "{{ infra_state }}"
        tags:
          Project: "{{ project_tag }}"
          Role: Bastion
        wait: yes
      when: not (existing_instances.instances | selectattr('tags.Role', 'equalto', 'Bastion') | list)

    - name: Create Web instance
      amazon.aws.ec2_instance:
        name: "{{ project_tag }}-web"
        security_group: "{{ web_sg_name }}"
        instance_type: "{{ instance_type }}"
        image_id: "{{ debian_ami_id }}"
        key_name: "{{ webdev_key_name }}"
        region: "{{ aws_region }}"
        state: "{{ infra_state }}"
        tags:
          Project: "{{ project_tag }}"
          Role: Web
        wait: yes
      when: not (existing_instances.instances | selectattr('tags.Role', 'equalto', 'Web') | list)

    - name: Create DB instance
      amazon.aws.ec2_instance:
        name: "{{ project_tag }}-db"
        security_group: "{{ db_sg_name }}"
        instance_type: "{{ instance_type }}"
        image_id: "{{ debian_ami_id }}"
        key_name: "{{ webdev_key_name }}"
        region: "{{ aws_region }}"
        state: "{{ infra_state }}"
        tags:
          Project: "{{ project_tag }}"
          Role: DB
        wait: yes
      when: not (existing_instances.instances | selectattr('tags.Role', 'equalto', 'DB') | list)
  when: infra_state == "present"

- name: Set bastion_instance_id fact
  ansible.builtin.set_fact:
    bastion_instance_id: "{{ bastion_instance.instance_id }}"
  when: infra_state == "present"

- name: Set web_instance_id fact
  ansible.builtin.set_fact:
    web_instance_id: "{{ web_instance.instance_id }}"
  when: infra_state == "present"

- name: Set db_instance_id fact
  ansible.builtin.set_fact:
    db_instance_id: "{{ db_instance.instance_id }}"
  when: infra_state == "present"

# ---- Key Pair ----

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "/home/admin/.ssh"
    state: directory
    mode: '0700'
    owner: admin
    group: admin
  when: infra_state == "present"

- name: Create AWS key pair
  amazon.aws.ec2_key:
    name: "{{ webdev_key_name }}"
    region: "{{ aws_region }}"
    state: present
    force: false  # Don't replace if it exists
  register: key_pair_result
  when: infra_state == "present"

- name: Save private key if newly created
  ansible.builtin.copy:
    content: "{{ key_pair_result.key.private_key }}"
    dest: "/home/admin/.ssh/{{ webdev_key_name }}.pem"
    mode: '0600'
    owner: admin
    group: admin
  when:
    - infra_state == "present"
    - key_pair_result.changed

# ---- Check existing instances ----

- name: Check for existing Bastion instance
  amazon.aws.ec2_instance_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Project": "{{ project_tag }}"
      "tag:Role": "Bastion"
      instance-state-name: ["pending", "running"]
  register: existing_bastion
  when: infra_state == "present"

- name: Check for existing Web instance
  amazon.aws.ec2_instance_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Project": "{{ project_tag }}"
      "tag:Role": "Web"
      instance-state-name: ["pending", "running"]
  register: existing_web
  when: infra_state == "present"

- name: Check for existing DB instance
  amazon.aws.ec2_instance_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Project": "{{ project_tag }}"
      "tag:Role": "DB"
      instance-state-name: ["pending", "running"]
  register: existing_db
  when: infra_state == "present"

# ---- Instances (present) ----

- name: Ensure Bastion instance exists
  amazon.aws.ec2_instance:
    name: "{{ bastion_tag_name }}"
    instance_type: "{{ instance_type }}"
    image_id: "{{ ami_id }}"
    key_name: "{{ key_name }}"
    security_group: "{{ bastion_sg_name }}"
    network:
      assign_public_ip: true
    tags:
      Name: "{{ bastion_tag_name }}"
      Role: "Bastion"
      Project: "{{ project_tag }}"
    exact_count: 1
    count_tag:
      Role: "Bastion"
    vpc_subnet_id: "{{ web_subnet_id | default(omit) }}"
    state: "{{ infra_state }}"
    wait: yes
    region: "{{ aws_region }}"
  register: bastion_instance
  when: infra_state == "present" and (existing_bastion.instances | length == 0)

- name: Use existing Bastion instance
  ansible.builtin.set_fact:
    bastion_instance: "{{ existing_bastion }}"
  when: infra_state == "present" and (existing_bastion.instances | length > 0)

- name: Ensure Web instance exists
  amazon.aws.ec2_instance:
    name: "{{ web_tag_name }}"
    instance_type: "{{ instance_type }}"
    image_id: "{{ ami_id }}"
    key_name: "{{ key_name }}"
    security_group: "{{ web_sg_name }}"
    network:
      assign_public_ip: true
    tags:
      Name: "{{ web_tag_name }}"
      Role: "Web"
      Project: "{{ project_tag }}"
    exact_count: 1
    count_tag:
      Role: "Web"
    vpc_subnet_id: "{{ web_subnet_id | default(omit) }}"
    state: "{{ infra_state }}"
    wait: yes
    region: "{{ aws_region }}"
  register: web_instance
  when: infra_state == "present" and (existing_web.instances | length == 0)

- name: Use existing Web instance
  ansible.builtin.set_fact:
    web_instance: "{{ existing_web }}"
  when: infra_state == "present" and (existing_web.instances | length > 0)

- name: Ensure DB instance exists
  amazon.aws.ec2_instance:
    name: "{{ db_tag_name }}"
    instance_type: "{{ instance_type }}"
    image_id: "{{ ami_id }}"
    key_name: "{{ key_name }}"
    security_group: "{{ db_sg_name }}"
    network:
      assign_public_ip: false
    tags:
      Name: "{{ db_tag_name }}"
      Role: "DB"
      Project: "{{ project_tag }}"
    exact_count: 1
    count_tag:
      Role: "DB"
    vpc_subnet_id: "{{ db_subnet_id | default(omit) }}"
    state: "{{ infra_state }}"
    wait: yes
    region: "{{ aws_region }}"
  register: db_instance
  when: infra_state == "present" and (existing_db.instances | length == 0)

- name: Use existing DB instance
  ansible.builtin.set_fact:
    db_instance: "{{ existing_db }}"
  when: infra_state == "present" and (existing_db.instances | length > 0)

- name: Wait for SSH on bastion to become available
  ansible.builtin.wait_for:
    host: "{{ item.public_ip_address }}"
    port: 22
    delay: 10
    timeout: 320
    state: started
  loop: "{{ bastion_instance.instances }}"
  when: infra_state == "present"

- name: Pause for 30 seconds to let AWS EC2 inventory catch up
  ansible.builtin.pause:
    seconds: 30
  when: infra_state == "present"

- name: Clear dynamic inventory cache
  ansible.builtin.file:
    path: ~/.ansible/tmp/ansible-ec2-*.cache
    state: absent
  when: infra_state == "present"

# === Mode destruction ======================================

- name: Terminate all instances for this project
  amazon.aws.ec2_instance:
    region: "{{ aws_region }}"
    state: absent
    wait: true
    filters:
      "tag:Project": "{{ project_tag }}"
  when: infra_state == "absent"

- name: Wait for instances to be fully terminated
  ansible.builtin.pause:
    seconds: 30
  when: infra_state == "absent"

# Supprimer les règles de sécurité inter-groupes d'abord
- name: Remove cross-references in security groups
  amazon.aws.ec2_security_group:
    name: "{{ item }}"
    description: "Cleaning security group"
    region: "{{ aws_region }}"
    state: present
    rules: []
    rules_egress: []
    purge_rules: true
    purge_rules_egress: true
  loop:
    - "{{ db_sg_name }}"
    - "{{ web_sg_name }}"
    - "{{ bastion_sg_name }}"
  when: infra_state == "absent"

- name: Wait for security group rules to be removed
  ansible.builtin.pause:
    seconds: 10
  when: infra_state == "absent"

# On supprime les SG dans l'ordre DB -> Web -> Bastion avec gestion des erreurs
- name: Delete DB security group
  amazon.aws.ec2_security_group:
    name: "{{ db_sg_name }}"
    region: "{{ aws_region }}"
    state: absent
  register: delete_db_sg
  until: delete_db_sg is not failed
  retries: 6
  delay: 10
  when: infra_state == "absent"

- name: Delete Web security group
  amazon.aws.ec2_security_group:
    name: "{{ web_sg_name }}"
    region: "{{ aws_region }}"
    state: absent
  register: delete_web_sg
  until: delete_web_sg is not failed
  retries: 6
  delay: 10
  when: infra_state == "absent"

- name: Delete Bastion security group
  amazon.aws.ec2_security_group:
    name: "{{ bastion_sg_name }}"
    region: "{{ aws_region }}"
    state: absent
  register: delete_bastion_sg
  until: delete_bastion_sg is not failed
  retries: 6
  delay: 10
  when: infra_state == "absent"

- name: Update DB security group with Web server access
  amazon.aws.ec2_security_group:
    name: "{{ db_sg_name }}"
    description: "DB SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    vpc_id: "{{ vpc_id | default(omit) }}"
    state: present
    purge_rules: false
    rules:
      - proto: tcp
        from_port: 3306
        to_port: 3306
        group_id: "{{ web_sg_id }}"
        rule_desc: "Allow MySQL from Web servers"
  when: infra_state == "present"

- name: Update Web security group with DB access
  amazon.aws.ec2_security_group:
    name: "{{ web_sg_name }}"
    description: "Web SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    vpc_id: "{{ vpc_id | default(omit) }}"
    state: present
    purge_rules: false
    rules:
      - proto: tcp
        from_port: 3306
        to_port: 3306
        group_id: "{{ db_sg_id }}"
        rule_desc: "Allow MySQL access to DB servers"
  when: infra_state == "present"

- name: Update security groups for force_update
  block:
    - name: Get updated Bastion security group
      amazon.aws.ec2_security_group:
        name: "{{ bastion_sg_name }}"
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id | default(omit) }}"
        state: present
        rules:
          - proto: tcp
            from_port: 22
            to_port: 22
            cidr_ip: "{{ ssh_cidr }}"
            rule_desc: "Allow SSH from Internet"
        rules_egress:
          - proto: -1
            from_port: -1
            to_port: -1
            cidr_ip: "0.0.0.0/0"
            rule_desc: "Allow all outbound traffic"
        purge_rules: true
        purge_rules_egress: true
      register: bastion_sg_refresh
      when: force_update is defined and force_update

    - name: Update web_sg fact for force_update
      ansible.builtin.set_fact:
        bastion_sg_id: "{{ bastion_sg_refresh.group_id }}"
      when: force_update is defined and force_update and bastion_sg_refresh.changed

    - name: Get updated Web security group
      amazon.aws.ec2_security_group:
        name: "{{ web_sg_name }}"
        region: "{{ aws_region }}"
        vpc_id: "{{ vpc_id | default(omit) }}"
        state: present
        rules:
          - proto: tcp
            from_port: 80
            to_port: 80
            cidr_ip: "{{ web_http_cidr }}"
            rule_desc: "Allow HTTP from Internet"
          - proto: tcp
            from_port: 22
            to_port: 22
            group_id: "{{ bastion_sg_id }}"
            rule_desc: "Allow SSH only from Bastion"
        rules_egress:
          - proto: tcp
            from_port: 80
            to_port: 80
            cidr_ip: "0.0.0.0/0"
            rule_desc: "Allow HTTP outbound"
          - proto: tcp
            from_port: 443
            to_port: 443
            cidr_ip: "0.0.0.0/0"
            rule_desc: "Allow HTTPS outbound"
        purge_rules: true
        purge_rules_egress: true
      register: web_sg_refresh
      when: force_update is defined and force_update

    - name: Update web_sg fact for force_update
      ansible.builtin.set_fact:
        web_sg_id: "{{ web_sg_refresh.group_id }}"
      when: force_update is defined and force_update and web_sg_refresh.changed
  when: infra_state == "present"

- name: Create instances with proper conditions
  block:
    - name: Create Bastion instance only if none exists
      amazon.aws.ec2_instance:
        name: "webdev-bastion"
        region: "{{ aws_region }}"
        image_id: "{{ debian_ami_id }}"
        instance_type: "{{ instance_type }}"
        key_name: "{{ webdev_key_name }}"
        security_groups: ["{{ bastion_sg_id }}"]
        network:
          assign_public_ip: true
          subnet_id: "{{ subnet_id | default(omit) }}"
        state: running
        wait: true
        count: 1
        filters:
          instance-state-name: ["pending", "running"]
          "tag:Project": "{{ project_tag }}"
          "tag:Role": "Bastion"
        tags:
          Project: "{{ project_tag }}"
          Role: "Bastion"
          Name: "webdev-bastion"
      register: bastion_instance
      when: (existing_bastion.instances | length == 0)

    - name: Create Web instance only if none exists
      amazon.aws.ec2_instance:
        name: "webdev-web"
        region: "{{ aws_region }}"
        image_id: "{{ debian_ami_id }}"
        instance_type: "{{ instance_type }}"
        key_name: "{{ webdev_key_name }}"
        security_groups: ["{{ web_sg_id }}"]
        network:
          assign_public_ip: true
          subnet_id: "{{ subnet_id | default(omit) }}"
        state: running
        wait: true
        count: 1
        filters:
          instance-state-name: ["pending", "running"]
          "tag:Project": "{{ project_tag }}"
          "tag:Role": "Web"
        tags:
          Project: "{{ project_tag }}"
          Role: "Web"
          Name: "webdev-web"
      register: web_instance
      when: (existing_web.instances | length == 0)

    - name: Create DB instance only if none exists
      amazon.aws.ec2_instance:
        name: "webdev-db"
        region: "{{ aws_region }}"
        image_id: "{{ debian_ami_id }}"
        instance_type: "{{ instance_type }}"
        key_name: "{{ webdev_key_name }}"
        security_groups: ["{{ db_sg_id }}"]
        network:
          assign_public_ip: false
          subnet_id: "{{ subnet_id | default(omit) }}"
        state: running
        wait: true
        count: 1
        filters:
          instance-state-name: ["pending", "running"]
          "tag:Project": "{{ project_tag }}"
          "tag:Role": "DB"
        tags:
          Project: "{{ project_tag }}"
          Role: "DB"
          Name: "webdev-db"
      register: db_instance
      when: (existing_db.instances | length == 0)
  when: infra_state == "present"
