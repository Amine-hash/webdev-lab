- name: Create Bastion security group
  amazon.aws.ec2_security_group:
    name: "{{ bastion_sg_name }}"
    description: "Bastion SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    state: present
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        cidr_ip: "{{ ssh_cidr }}"
    rules_egress:
      - proto: -1
        from_port: 0
        to_port: 0
        cidr_ip: "0.0.0.0/0"
  register: bastion_sg
  when: infra_state == "present"

- name: Set bastion_sg_id fact
  ansible.builtin.set_fact:
    bastion_sg_id: "{{ bastion_sg.group_id }}"
  when: infra_state == "present"

- name: Create Web security group
  amazon.aws.ec2_security_group:
    name: "{{ web_sg_name }}"
    description: "Web SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    state: present
    rules:
      - proto: tcp
        from_port: 80
        to_port: 80
        cidr_ip: "{{ web_http_cidr }}"
        rule_desc: "Allow HTTP from Internet"
      - proto: tcp
        from_port: 22
        to_port: 22
        group_id: "{{ bastion_sg_id }}"
        rule_desc: "Allow SSH only from Bastion"
    rules_egress:
      - proto: tcp
        from_port: 3306
        to_port: 3306
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow MySQL to DB servers"
      - proto: tcp
        from_port: 80
        to_port: 80
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow HTTP outbound"
      - proto: tcp
        from_port: 443
        to_port: 443
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow HTTPS outbound"
  register: web_sg
  when: infra_state == "present"

- name: Set web_sg_id fact
  ansible.builtin.set_fact:
    web_sg_id: "{{ web_sg.group_id }}"
  when: infra_state == "present"

- name: Create DB security group (initial)
  amazon.aws.ec2_security_group:
    name: "{{ db_sg_name }}"
    description: "DB SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    state: present
    vpc_id: "{{ vpc_id | default(omit) }}"
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        group_id: "{{ bastion_sg_id }}"
        rule_desc: "Allow SSH from Bastion"
      - proto: tcp
        from_port: 80
        to_port: 80
        group_id: "{{ bastion_sg_id }}"
        rule_desc: "Allow phpMyAdmin access only from Bastion"
      - proto: tcp
        from_port: 3306
        to_port: 3306
        group_id: "{{ bastion_sg_id }}"
        rule_desc: "Allow MySQL from Bastion"
    rules_egress:
      - proto: -1
        from_port: 0
        to_port: 0
        cidr_ip: "0.0.0.0/0"
  register: db_sg
  when: infra_state == "present"

- name: Set db_sg_id fact
  ansible.builtin.set_fact:
    db_sg_id: "{{ db_sg.group_id }}"
  when: infra_state == "present"

# ---- Key Pair ----

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "/home/admin/.ssh"
    state: directory
    mode: '0700'
    owner: admin
    group: admin
  when: infra_state == "present"

- name: Create AWS key pair
  amazon.aws.ec2_key:
    name: "{{ webdev_key_name }}"
    region: "{{ aws_region }}"
    state: present
    force: false  # Don't replace if it exists
  register: key_pair_result
  when: infra_state == "present"

- name: Save private key if newly created
  ansible.builtin.copy:
    content: "{{ key_pair_result.key.private_key }}"
    dest: "/home/admin/.ssh/{{ webdev_key_name }}.pem"
    mode: '0600'
    owner: admin
    group: admin
  when:
    - infra_state == "present"
    - key_pair_result.changed

# ---- Instances (present) ----

- name: Ensure Bastion instance exists
  amazon.aws.ec2_instance:
    name: "webdev-bastion"
    region: "{{ aws_region }}"
    image_id: "{{ debian_ami_id }}"
    instance_type: "{{ instance_type }}"
    key_name: "{{ webdev_key_name }}"
    security_groups: ["{{ bastion_sg_id }}"]
    network:
      assign_public_ip: true
    state: running
    wait: true
    count: 1
    filters:
      instance-state-name: ["pending", "running", "stopping", "stopped"]
      "tag:Project": "{{ project_tag }}"
      "tag:Role": "Bastion"
      "tag:Name": "webdev-bastion"
    tags:
      Project: "{{ project_tag }}"
      Role: "Bastion"
      Name: "webdev-bastion"
  register: bastion_instance
  when: infra_state == "present"

- name: Ensure Web instance exists
  amazon.aws.ec2_instance:
    name: "webdev-web"
    region: "{{ aws_region }}"
    image_id: "{{ debian_ami_id }}"
    instance_type: "{{ instance_type }}"
    key_name: "{{ webdev_key_name }}"
    security_groups: ["{{ web_sg_id }}"]
    network:
      assign_public_ip: true
    state: running
    wait: true
    count: 1
    filters:
      instance-state-name: running
      "tag:Project": "{{ project_tag }}"
      "tag:Role": "Web"
    tags:
      Project: "{{ project_tag }}"
      Role: "Web"
      Name: "webdev-web"
  register: web_instance
  when: infra_state == "present"

- name: Ensure DB instance exists
  amazon.aws.ec2_instance:
    name: "webdev-db"
    region: "{{ aws_region }}"
    image_id: "{{ debian_ami_id }}"
    instance_type: "{{ instance_type }}"
    key_name: "{{ webdev_key_name }}"
    security_groups: ["{{ db_sg_id }}"]
    network:
      assign_public_ip: true
    state: running
    wait: true
    count: 1
    filters:
      instance-state-name: running
      "tag:Project": "{{ project_tag }}"
      "tag:Role": "DB"
    tags:
      Project: "{{ project_tag }}"
      Role: "DB"
      Name: "webdev-db"
  register: db_instance
  when: infra_state == "present"

- name: Wait for SSH on bastion to become available
  ansible.builtin.wait_for:
    host: "{{ item.public_ip_address }}"
    port: 22
    delay: 10
    timeout: 320
    state: started
  loop: "{{ bastion_instance.instances }}"
  when: infra_state == "present"

- name: Pause for 30 seconds to let AWS EC2 inventory catch up
  ansible.builtin.pause:
    seconds: 30
  when: infra_state == "present"

- name: Clear dynamic inventory cache
  ansible.builtin.file:
    path: ~/.ansible/tmp/ansible-ec2-*.cache
    state: absent
  when: infra_state == "present"

# === Mode destruction ======================================

- name: Terminate all instances for this project
  amazon.aws.ec2_instance:
    region: "{{ aws_region }}"
    state: absent
    wait: true
    filters:
      "tag:Project": "{{ project_tag }}"
  when: infra_state == "absent"

# On supprime les SG dans l'ordre DB -> Web -> Bastion
- name: Delete DB security group
  amazon.aws.ec2_security_group:
    name: "{{ db_sg_name }}"
    region: "{{ aws_region }}"
    state: absent
  when: infra_state == "absent"

- name: Delete Web security group
  amazon.aws.ec2_security_group:
    name: "{{ web_sg_name }}"
    region: "{{ aws_region }}"
    state: absent
  when: infra_state == "absent"

- name: Delete Bastion security group
  amazon.aws.ec2_security_group:
    name: "{{ bastion_sg_name }}"
    region: "{{ aws_region }}"
    state: absent
  when: infra_state == "absent"

- name: Update DB security group with Web server access
  amazon.aws.ec2_security_group:
    name: "{{ db_sg_name }}"
    description: "DB SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    state: present
    purge_rules: false
    rules:
      - proto: tcp
        from_port: 3306
        to_port: 3306
        group_id: "{{ web_sg_id }}"
        rule_desc: "Allow MySQL from Web servers"
  register: db_sg_update
  when: infra_state == "present"

- name: Update Web security group with DB access
  amazon.aws.ec2_security_group:
    name: "{{ web_sg_name }}"
    description: "Web SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    state: present
    purge_rules: false
    rules:
      - proto: tcp
        from_port: 3306
        to_port: 3306
        group_id: "{{ db_sg_id }}"
        rule_desc: "Allow MySQL access to DB servers"
  register: web_sg_update
  when: infra_state == "present"
