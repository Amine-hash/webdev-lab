- name: Create Bastion security group
  amazon.aws.ec2_security_group:
    name: "{{ bastion_sg_name }}"
    description: "Bastion SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    vpc_id: "{{ vpc_id | default(omit) }}"
    state: "{{ infra_state }}"
    purge_rules: true
    purge_rules_egress: true
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        cidr_ip: "{{ ssh_cidr }}"
        rule_desc: "Allow SSH from Internet"
    rules_egress:
      - proto: -1
        from_port: -1
        to_port: -1
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow all outbound traffic"
  register: bastion_sg
  tags: [infra]
  when: infra_state == "present"

- name: Set bastion_sg_id fact
  ansible.builtin.set_fact:
    bastion_sg_id: "{{ bastion_sg.group_id }}"
  when: infra_state == "present"

- name: Create Web security group
  amazon.aws.ec2_security_group:
    name: "{{ web_sg_name }}"
    description: "Web SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    vpc_id: "{{ vpc_id | default(omit) }}"
    state: "{{ infra_state }}"
    purge_rules: true
    purge_rules_egress: true
    rules:
      - proto: tcp
        from_port: 80
        to_port: 80
        cidr_ip: "{{ web_http_cidr }}"
        rule_desc: "Allow HTTP from Internet"
      - proto: tcp
        from_port: 22
        to_port: 22
        group_id: "{{ bastion_sg_id }}"
        rule_desc: "Allow SSH only from Bastion"
    rules_egress:
      - proto: -1
        from_port: -1
        to_port: -1
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow all outbound traffic"
  register: web_sg
  when: infra_state == "present"

- name: Set web_sg_id fact
  ansible.builtin.set_fact:
    web_sg_id: "{{ web_sg.group_id }}"
  when: infra_state == "present" and web_sg.group_id is defined

- name: Create DB security group
  amazon.aws.ec2_security_group:
    name: "{{ db_sg_name }}"
    description: "DB SG for {{ project_tag }}"
    region: "{{ aws_region }}"
    vpc_id: "{{ vpc_id | default(omit) }}"
    state: "{{ infra_state }}"
    purge_rules: true
    purge_rules_egress: true
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        group_id: "{{ bastion_sg_id }}"
        rule_desc: "Allow SSH from Bastion"
      - proto: tcp
        from_port: "{{ db_port | int }}"
        to_port: "{{ db_port | int }}"
        group_id: "{{ web_sg.group_id }}"
        rule_desc: "Allow DB access from Web servers"
    rules_egress:
      - proto: -1
        from_port: -1
        to_port: -1
        cidr_ip: "0.0.0.0/0"
        rule_desc: "Allow all outbound traffic"
  register: db_sg
  when: infra_state == "present"

- name: Set db_sg_id fact
  ansible.builtin.set_fact:
    db_sg_id: "{{ db_sg.group_id }}"
  when: infra_state == "present" and db_sg.group_id is defined

- name: Lookup existing Bastion instance
  amazon.aws.ec2_instance_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Project": "{{ project_tag }}"
      "tag:Role": "Bastion"
      "instance-state-name": ["pending", "running"]
  register: bastion_info
  when: infra_state == "present"

- name: Ensure Bastion instance exists (create only if none)
  amazon.aws.ec2_instance:
    name: "{{ project_tag }}-bastion"
    instance_type: "{{ instance_type }}"
    image_id: "{{ debian_ami_id }}"
    key_name: "{{ webdev_key_name }}"
    security_group: "{{ bastion_sg_name }}"
    network:
      assign_public_ip: true
      subnet_id: "{{ public_subnet_id | default(omit) }}"
    tags:
      Name: "{{ project_tag }}-bastion"
      Role: "Bastion"
      Project: "{{ project_tag }}"
    state: running
    wait: yes
    region: "{{ aws_region }}"
  register: bastion_instance
  when:
    - infra_state == "present"
    - bastion_info.instances | length == 0

- name: Determine Bastion public IP from newly created instance
  ansible.builtin.set_fact:
    bastion_public_ip: "{{ bastion_instance.instances[0].public_ip_address }}"
  when:
    - infra_state == "present"
    - bastion_instance is defined
    - bastion_instance is not skipped
    - bastion_instance.instances is defined
    - bastion_instance.instances | length > 0

- name: Determine Bastion public IP from existing instance
  ansible.builtin.set_fact:
    bastion_public_ip: "{{ bastion_info.instances[0].public_ip_address }}"
  when:
    - infra_state == "present"
    - (bastion_instance is not defined or bastion_instance is skipped or bastion_instance.instances is not defined or bastion_instance.instances | length == 0)
    - bastion_info is defined
    - bastion_info.instances is defined
    - bastion_info.instances | length > 0

- name: Fail if bastion_public_ip could not be determined
  ansible.builtin.fail:
    msg: "Could not determine bastion_public_ip from EC2 API results"
  when:
    - infra_state == "present"
    - bastion_public_ip is not defined

- name: Wait for SSH on Bastion to become available
  ansible.builtin.wait_for:
    host: "{{ bastion_public_ip }}"
    port: 22
    delay: 10
    timeout: 320
    state: started
  when:
    - infra_state == "present"
    - bastion_public_ip is defined

- name: Lookup existing Web instance
  amazon.aws.ec2_instance_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Project": "{{ project_tag }}"
      "tag:Role": "Web"
      "instance-state-name": ["pending", "running"]
  register: web_info
  when: infra_state == "present"

- name: Ensure Web instance exists (create only if none)
  amazon.aws.ec2_instance:
    name: "{{ project_tag }}-web"
    instance_type: "{{ instance_type }}"
    image_id: "{{ debian_ami_id }}"
    key_name: "{{ webdev_key_name }}"
    security_group: "{{ web_sg_name }}"
    network:
      assign_public_ip: true
      subnet_id: "{{ public_subnet_id | default(omit) }}"
    tags:
      Name: "{{ project_tag }}-web"
      Role: "Web"
      Project: "{{ project_tag }}"
    state: running
    wait: yes
    region: "{{ aws_region }}"
  register: web_instance
  when:
    - infra_state == "present"
    - web_info.instances | length == 0

- name: Lookup existing DB instance
  amazon.aws.ec2_instance_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Project": "{{ project_tag }}"
      "tag:Role": "DB"
      "instance-state-name": ["pending", "running"]
  register: db_info
  when: infra_state == "present"

- name: Ensure DB instance exists (create only if none)
  amazon.aws.ec2_instance:
    name: "{{ project_tag }}-db"
    instance_type: "{{ instance_type }}"
    image_id: "{{ debian_ami_id }}"
    key_name: "{{ webdev_key_name }}"
    security_group: "{{ db_sg_name }}"
    network:
      assign_public_ip: false
      subnet_id: "{{ private_subnet_id | default(omit) }}"
    tags:
      Name: "{{ project_tag }}-db"
      Role: "DB"
      Project: "{{ project_tag }}"
    state: running
    wait: yes
    region: "{{ aws_region }}"
  register: db_instance
  when:
    - infra_state == "present"
    - db_info.instances | length == 0

- name: Debug subnet utilisé pour la DB
  debug:
    msg: |
      Utilisation du subnet pour la DB :
        private_subnet_id = {{ private_subnet_id }}
        private_subnet_auto_managed = {{ private_subnet_auto_managed | default(false) }}
  when: infra_state == "present"

- name: Assert DB has no public IP
  amazon.aws.ec2_instance_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Project": "{{ project_tag }}"
      "tag:Role": "DB"
      "instance-state-name": ["running","pending"]
  register: db_check
  when: infra_state == "present"

- name: Fail if DB has a public IP
  ansible.builtin.assert:
    that:
      - db_check.instances | length > 0
      - (db_check.instances[0].public_ip_address | default('')) == ''
    fail_msg: "La DB possède une IP publique: corrige subnet/assign_public_ip."
  when: infra_state == "present"

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "/home/admin/.ssh"
    state: directory
    mode: '0700'
    owner: admin
    group: admin
  when: infra_state == "present"

- name: Create AWS key pair
  amazon.aws.ec2_key:
    name: "{{ webdev_key_name }}"
    region: "{{ aws_region }}"
    state: present
    force: false
  register: key_pair_result
  when: infra_state == "present"

- name: Save private key if newly created
  ansible.builtin.copy:
    content: "{{ key_pair_result.key.private_key }}"
    dest: "/home/admin/.ssh/{{ webdev_key_name }}.pem"
    mode: '0600'
    owner: admin
    group: admin
  when:
    - infra_state == "present"
    - key_pair_result.changed

- name: Terminate all instances for this project
  amazon.aws.ec2_instance:
    region: "{{ aws_region }}"
    state: absent
    wait: true
    filters:
      "tag:Project": "{{ project_tag }}"
  when: infra_state == "absent"

- name: Wait for instances to be fully terminated
  ansible.builtin.pause:
    seconds: 30
  when: infra_state == "absent"

- name: Delete DB security group
  amazon.aws.ec2_security_group:
    name: "{{ db_sg_name }}"
    region: "{{ aws_region }}"
    state: absent
  register: delete_db_sg
  until: delete_db_sg is not failed
  retries: 6
  delay: 10
  when: infra_state == "absent"

- name: Delete Web security group
  amazon.aws.ec2_security_group:
    name: "{{ web_sg_name }}"
    region: "{{ aws_region }}"
    state: absent
  register: delete_web_sg
  until: delete_web_sg is not failed
  retries: 6
  delay: 10
  when: infra_state == "absent"

- name: Delete Bastion security group
  amazon.aws.ec2_security_group:
    name: "{{ bastion_sg_name }}"
    region: "{{ aws_region }}"
    state: absent
  register: delete_bastion_sg
  until: delete_bastion_sg is not failed
  retries: 6
  delay: 10
  when: infra_state == "absent"

- name: Lookup existing private subnet for DB (by tag)
  amazon.aws.ec2_vpc_subnet_info:
    filters:
      vpc-id: vpc-03ab4238efb2cc320
      tag:Project: "{{ project_tag }}"
      tag:Name: "webdev-db-private-subnet"
      cidr-block: "172.31.240.0/20"
  register: found_private_subnet
  when:
    - infra_state == "present"
    - (private_subnet_id is not defined or private_subnet_id == "")

- name: Create private subnet for DB if not found
  amazon.aws.ec2_vpc_subnet:
    vpc_id: "vpc-03ab4238efb2cc320"
    cidr: "172.31.240.0/20"
    map_public: false
    state: present
    tags:
      Name: "webdev-db-private-subnet"
      Project: "{{ project_tag }}"
  register: created_private_subnet
  when:
    - infra_state == "present"
    - (private_subnet_id is not defined or private_subnet_id == "")
    - (found_private_subnet.subnets is not defined or found_private_subnet.subnets | length == 0)

- name: Set private_subnet_id fact (auto-managed)
  ansible.builtin.set_fact:
    private_subnet_id: >-
      {{
        (found_private_subnet.subnets[0].id if found_private_subnet.subnets is defined and found_private_subnet.subnets | length > 0 else created_private_subnet.subnet.id)
      }}
    private_subnet_auto_managed: true
  when:
    - infra_state == "present"
    - (private_subnet_id is not defined or private_subnet_id == "")
    - ((found_private_subnet.subnets is defined and found_private_subnet.subnets | length > 0) or (created_private_subnet.subnet is defined))

- name: Delete auto-managed private subnet (after all resources)
  amazon.aws.ec2_vpc_subnet:
    vpc_id: "vpc-03ab4238efb2cc320"
    cidr: "172.31.240.0/20"
    state: absent
  when:
    - infra_state == "absent"
    - private_subnet_auto_managed | default(false)
