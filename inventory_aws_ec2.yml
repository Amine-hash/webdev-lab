plugin: aws_ec2
regions:
  - us-east-1

filters:
  tag:Project: webdev-lab
  instance-state-name: running

keyed_groups:
  - key: tags.Role
    prefix: tag_Role_
    separator: ''

hostnames:
  - tag:Name
  - private_dns_name
  - public_dns_name

compose:
  ansible_host: >-
    {%- if tags.Role == "Bastion" -%}
    {{ public_ip_address }}
    {%- else -%}
    {{ private_ip_address }}
    {%- endif -%}
  ansible_user: "admin"
  ansible_ssh_private_key_file: "/home/admin/.ssh/labsuser.pem"
  ansible_ssh_common_args: >-
    {%- if tags.Role != "Bastion" -%}
    -o ProxyCommand='ssh -W %h:%p -i /home/admin/.ssh/labsuser.pem admin@{{ groups["tag_Role_Bastion"] | map("extract", hostvars) | selectattr("public_ip_address", "defined") | map(attribute="public_ip_address") | first }}'
    {%- endif -%}
