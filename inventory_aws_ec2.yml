plugin: aws_ec2
regions:
  - us-east-1

filters:
  tag:Project: webdev-lab
  instance-state-name: running

strict: no
hostnames:
  - private-ip-address
  - public-ip-address
  - tag:Name
  - private-dns-name

keyed_groups:
  - key: tags.Role
    prefix: tag_Role_
    separator: ''

compose:
  # Définition de l'hôte principal pour SSH
  ansible_host: >-
    {%- if tags.Role == "Bastion" -%}
    {{- public_ip_address -}}
    {%- else -%}
    {{- private_ip_address -}}
    {%- endif -%}

  # Configuration utilisateur commune
  ansible_user: admin
  ansible_ssh_private_key_file: /home/admin/.ssh/labsuser.pem

  # Configuration SSH pour le bastion
  ansible_ssh_common_args: >-
    {%- if tags.Role != "Bastion" -%}
    -o StrictHostKeyChecking=no 
    -o UserKnownHostsFile=/dev/null 
    -o ProxyCommand="ssh -q -W %h:%p -i /home/admin/.ssh/labsuser.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null admin@{{ groups['tag_Role_Bastion'] | map('extract', hostvars) | selectattr('public_ip_address', 'defined') | map(attribute='public_ip_address') | first }}"
    {%- endif -%}

  # Configuration supplémentaire pour le bastion
  ansible_ssh_extra_args: >-
    {%- if tags.Role == "Bastion" -%}
    -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
    {%- endif -%}

  # Variables pour le bastion
  bastion_public_ip: >-
    {%- if tags.Role == "Bastion" -%}
    {{- public_ip_address -}}
    {%- endif -%}

  # Variables pour les hôtes internes
  private_ip: "{{ private_ip_address }}"
  ansible_ssh_host: "{{ private_ip_address }}"

  # Variables de débogage
  public_ip_address: public_ip_address
  private_ip_address: private_ip_address
  instance_id: instance_id
