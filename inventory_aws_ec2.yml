plugin: aws_ec2
regions:
  - us-east-1

filters:
  tag:Project: webdev-lab
  instance-state-name: running

strict: no
hostnames:
  - tag:Name
  - private-ip-address

keyed_groups:
  - key: tags.Role
    prefix: tag_Role_
    separator: ''

compose:
  ansible_host: "{% if tags.Role == 'Bastion' %}public_ip_address{% else %}private_ip_address{% endif %}"
  ansible_user: admin
  ansible_ssh_private_key_file: /home/admin/.ssh/labsuser.pem
  ansible_ssh_common_args: >-
    -o StrictHostKeyChecking=no
    -o UserKnownHostsFile=/dev/null
    -o ForwardAgent=yes
    -o ControlMaster=auto
    -o ControlPersist=60s
    -o ServerAliveInterval=30
    -o ConnectTimeout=60
    -o TCPKeepAlive=yes
  ansible_ssh_extra_args: >-
    {%- if tags.Role != "Bastion" -%}
    -o ProxyCommand="ssh -i {{ ansible_ssh_private_key_file }} -W %h:%p -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ForwardAgent=yes -o BatchMode=yes {{ ansible_user }}@{{ hostvars[groups['tag_Role_Bastion'][0]].public_ip_address }}"
    {%- endif -%}

  # Variables utiles pour le reste du playbook
  public_ip: public_ip_address
  private_ip: private_ip_address
  instance_id: instance_id
  instance_name: tags.Name
  instance_role: tags.Role
