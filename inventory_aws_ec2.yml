plugin: aws_ec2
regions:
  - us-east-1

filters:
  tag:Project: webdev
  instance-state-name: ["running"]

strict: no
hostnames:
  - private-dns-name

keyed_groups:
  - key: tags.Role
    prefix: tag_Role

compose:
  ansible_host: >-
    {%- if tags.Role == 'Bastion' -%}
    {{ public_ip_address }}
    {%- else -%}
    {{ private_ip_address }}
    {%- endif -%}
  public_ip_address: '{{ public_ip_address }}'
  private_ip_address: '{{ private_ip_address }}'
  ansible_user: admin
  ansible_ssh_private_key_file: "/home/admin/.ssh/labsuser.pem"
  ansible_ssh_common_args: >-
    -o StrictHostKeyChecking=no
    -o UserKnownHostsFile=/dev/null
    -o ForwardAgent=yes
    -o BatchMode=yes
    -o ConnectTimeout=60
    -o ServerAliveInterval=30
    {%- if tags.Role != 'Bastion' -%}
    -o ProxyCommand="ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o IdentityFile=/home/admin/.ssh/labsuser.pem -W %h:%p -q admin@{{ hostvars[groups['tag_Role_Bastion'][0]]['public_ip_address'] }}"
    {%- endif -%}
